<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>FrameSync ‚Äì Dashboard</title>
  <link rel="stylesheet" href="style.css" />
  <script src="config.js"></script>
</head>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const wrapper = document.querySelector('.avatar-status-wrapper');
    const menu = wrapper.querySelector('.status-menu');

    wrapper.addEventListener('click', e => {
      e.stopPropagation();
      menu.classList.toggle('show');
    });

    wrapper.querySelectorAll('.status-option').forEach(opt => {
      opt.addEventListener('click', () => {
        const status = opt.dataset.status;

        document.body.className = document.body.className.replace(/status-\w+/g, '');
        document.body.classList.add('status-' + status);

        localStorage.setItem('userStatus', status);
        syncStatusToServer(status);
        menu.classList.remove('show');
      });
    });

    const saved = localStorage.getItem('userStatus') || 'available';
    document.body.classList.add('status-' + saved);

    document.addEventListener('click', () => menu.classList.remove('show'));
  });
</script>

<body>

  <!-- NAVBAR -->
  <nav class="navbar">
    <div class="logo"><a href="dashboard.html">FrameSync</a></div>

    <div class="nav-links">
      <a href="dashboard.html" class="active">Home</a>
      <a href="public.html">Public</a>
      <a href="room.html">Room</a>
      <a href="contact.html">Contact</a>
      <a href="profile.html">Profile</a>
    </div>

    <!-- 
    <div class="notification-wrapper">
      <button id="notif-btn" class="notif-btn">
        üîî<span id="notif-badge" class="notif-badge" style="display:none">0</span>
      </button>
      <div id="notif-dropdown" class="notif-dropdown">
        <div class="notif-header">Notifications</div>
        <div id="notif-list" class="notif-list">
          <div class="notif-empty">No new notifications</div>
        </div>
      </div>
    </div>
    -->

    <div class="avatar-status-wrapper">
      <img id="nav-avatar" src="https://via.placeholder.com/40" alt="Avatar" class="avatar">
      <div class="status-indicator"></div>

      <div class="status-menu">
        <div class="status-option" data-status="available">Available</div>
        <div class="status-option" data-status="watching">Watching</div>
        <div class="status-option" data-status="dnd">Do not disturb</div>
        <div class="status-option" data-status="silent">Silent</div>
        <div class="status-option" onclick="logout()" style="border-top: 1px solid #333; color: #ff3366 !important;">
          Logout</div>
      </div>
    </div>
    </div>
  </nav>

  <style>
    /* Notification Styles
    .notification-wrapper {
      position: relative;
      margin-right: 15px;
    }

    .notif-btn {
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      position: relative;
    }

    .notif-badge {
      position: absolute;
      top: -5px;
      right: -5px;
      background: var(--accent);
      color: white;
      font-size: 0.7rem;
      padding: 2px 6px;
      border-radius: 50%;
      font-weight: bold;
    }

    .notif-dropdown {
      display: none;
      position: absolute;
      top: 120%;
      right: 0;
      width: 300px;
      background: var(--bg-panel);
      border: 1px solid var(--border);
      border-radius: 12px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
      z-index: 1000;
      overflow: hidden;
    }

    .notif-dropdown.show {
      display: block;
    }

    .notif-header {
      padding: 15px;
      background: rgba(255, 255, 255, 0.05);
      font-weight: bold;
      border-bottom: 1px solid var(--border);
    }

    .notif-list {
      max-height: 300px;
      overflow-y: auto;
    }

    .notif-item {
      padding: 15px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      display: flex;
      align-items: start;
      gap: 10px;
    }

    .notif-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      object-fit: cover;
    }

    .notif-content {
      flex: 1;
      font-size: 0.9rem;
    }

    .notif-actions {
      display: flex;
      gap: 10px;
      margin-top: 8px;
    }

    .btn-accept {
      background: var(--accent);
      color: white;
      border: none;
      padding: 5px 10px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.8rem;
    }

    .btn-deny {
      background: rgba(255, 255, 255, 0.1);
      color: white;
      border: none;
      padding: 5px 10px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.8rem;
    }

    .notif-empty {
      padding: 20px;
      text-align: center;
      color: #888;
      font-style: italic;
    }
    */
  </style>

  <script>
    /* Notification Logic
    document.addEventListener('DOMContentLoaded', () => {
      const btn = document.getElementById('notif-btn');
      const dropdown = document.getElementById('notif-dropdown');
      const list = document.getElementById('notif-list');
      const badge = document.getElementById('notif-badge');

      btn.addEventListener('click', (e) => {
        e.stopPropagation();
        dropdown.classList.toggle('show');
      });

      document.addEventListener('click', () => dropdown.classList.remove('show'));
      dropdown.addEventListener('click', e => e.stopPropagation());

      fetchNotifications();

      async function fetchNotifications() {
        const token = localStorage.getItem('token');
        if (!token) return;

        try {
          const res = await fetch(CONFIG.getApiUrl('/api/notifications'), { headers: { 'Authorization': 'Bearer ' + token } });
          const notifications = await res.json();

          if (notifications.length > 0) {
            badge.style.display = 'block';
            badge.textContent = notifications.length;
            list.innerHTML = notifications.map(n => `
               <div class="notif-item" id="notif-${n.id}">
                 <img src="${n.from_avatar || 'https://via.placeholder.com/40'}" class="notif-avatar">
                 <div class="notif-content">
                   <div><strong>${n.from_name}</strong> sent you a friend request.</div>
                   <div class="notif-actions">
                     <button class="btn-accept" onclick="respondFriend('${n.id}', 'accept')">Accept</button>
                     <button class="btn-deny" onclick="respondFriend('${n.id}', 'deny')">Deny</button>
                   </div>
                 </div>
               </div>
             `).join('');
          } else {
            badge.style.display = 'none';
            list.innerHTML = '<div class="notif-empty">No new notifications</div>';
          }
        } catch (e) { console.error("Notif fetch failed", e); }
      }

      window.respondFriend = async (id, action) => {
        const token = localStorage.getItem('token');
        try {
          await fetch(CONFIG.getApiUrl('/api/friends/respond'), {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
            body: JSON.stringify({ requestId: id, action })
          });
          // Remove item from UI
          document.getElementById(`notif-${id}`).remove();

          // Update Badge
          const count = parseInt(badge.textContent) - 1;
          badge.textContent = count;
          if (count <= 0) {
            badge.style.display = 'none';
            list.innerHTML = '<div class="notif-empty">No new notifications</div>';
          }

          if (action === 'accept') {
            // Refresh friends list if available
            if (window.fetchFriends) window.fetchFriends();
          }
        } catch (e) { console.error("Respond failed", e); }
      };
    });
    */
  </script>


  <!-- DASHBOARD CONTENT -->
  <div class="container dashboard">

    <!-- HERO -->
    <div class="hero-guide mandatory">
      <h2 class="hero-title">
        <span class="hero-brand">FrameSync</span>
        <span class="hero-separator">‚Äî</span>
        <span class="hero-subtitle">Watch together. Anywhere.</span>
      </h2>
      <p class="hero-description">Watch together in real-time ‚Äî smooth, synced, secure.</p>

      <div class="steps">
        <div class="step">
          <div class="icon">1</div>
          <h4>Create or Join</h4>
          <p>Get a 6-letter code</p>
        </div>

        <div class="step">
          <div class="icon">2</div>
          <h4>Paste Video</h4>
          <p>YouTube, MP4, Drive</p>
        </div>

        <div class="step">
          <div class="icon">3</div>
          <h4>Sync & React</h4>
          <p>Host controls, you react</p>
        </div>

        <div class="step">
          <div class="icon">4</div>
          <h4>Get Recap</h4>
          <p>30-sec highlight video</p>
        </div>
      </div>
    </div>


    <!-- 4 CARDS -->
    <div class="unique-grid">
      <div class="card">
        <h3>Fresh Drops üçø</h3>
        <div id="fresh-drops-container">
          <p style="color:#666;">Loading latest hits...</p>
        </div>
      </div>

      <div class="card">
        <h3>Your Circle</h3>
        <div id="friends-grid" style="display:flex; flex-direction:column; gap:10px; margin-top:10px;">
          <p style="color:#666;">Loading friends...</p>
        </div>
      </div>

      <div class="card">
        <h3>Next Watch Planned</h3>
        <div id="next-watch-container">
          <p style="color:#666;">No upcoming scheduled rooms.</p>
          <button onclick="openScheduleModal()"
            style="margin-top:10px; padding:8px 16px; font-size:0.85rem; height:auto; width:auto; min-width:0;">Schedule
            Room</button>
        </div>
      </div>

      <div class="card">
        <h3>Reaction Leader</h3>
        <p id="reaction-leader">Start watching to react!</p>
      </div>
    </div>

    <!-- ACTION BUTTONS -->
    <div class="quick-actions">
      <button class="create-btn" onclick="openCreateModal()">Create New Room</button>
      <button class="join-btn" onclick="promptJoin()">Join with Code</button>
    </div>

  </div>



  <!-- CREATE ROOM MODAL -->
  <div id="create-modal" class="modal">
    <div class="modal-content">
      <h2>Create Room</h2>

      <!-- Toggle -->
      <div style="display:flex; justify-content:center; gap:10px; margin-bottom:15px;">
        <button id="btn-private" onclick="setRoomType('private')" class="tab-btn active"
          style="padding:8px 16px; font-size:0.9rem;">Private</button>
        <button id="btn-public" onclick="setRoomType('public')" class="tab-btn"
          style="padding:8px 16px; font-size:0.9rem; background:transparent; border:1px solid #444; color:#aaa;">Public</button>
      </div>

      <div id="public-options" style="display:none; margin-bottom:15px;">
        <p><strong>Room Name:</strong></p>
        <input type="text" id="room-name-input" placeholder="e.g. Movie Night" style="width:100%; margin-top:5px;">
      </div>

      <p><strong>Room Capacity:</strong></p>

      <select id="capacity-select"
        style="width:100%; margin-top:5px; padding:10px; background:#0F0F0F; border:1px solid var(--border); border-radius:8px; color:white; cursor:pointer;">
        <script>
          for (let i = 1; i <= 20; i++) {
            document.write(`<option value="${i}" ${i === 8 ? 'selected' : ''}>${i} Users</option>`);
          }
        </script>
      </select>

      <button onclick="createRoomWithCapacity()" style="margin-top:20px;">Create</button>
    </div>
  </div>



  <!-- SUCCESS MODAL -->
  <div id="success-modal" class="modal">
    <div class="modal-content">
      <h2>Your Room is Ready!</h2>

      <p><strong>Code:</strong> <span id="room-code"></span></p>
      <p><strong>Share Link:</strong> <span id="room-link"></span></p>

      <button onclick="copyCode()">Copy Code</button>
      <button onclick="copyLink()">Copy Link</button>
      <button onclick="goToRoom()">Go to Room</button>
    </div>
  </div>

  <!-- SCHEDULE ROOM MODAL -->
  <div id="schedule-modal" class="modal">
    <div class="modal-content">
      <h2>Schedule a Room</h2>

      <div style="margin-bottom: 15px;">
        <p><strong>Room Name:</strong></p>
        <input type="text" id="schedule-room-name" placeholder="e.g. Movie Night with Friends"
          style="width:100%; margin-top:5px;">
      </div>

      <div style="margin-bottom: 15px;">
        <p><strong>Date & Time:</strong></p>
        <input type="datetime-local" id="schedule-datetime"
          style="width:100%; margin-top:5px; padding:10px; background:#0F0F0F; border:1px solid var(--border); border-radius:8px; color:white;">
      </div>

      <div style="margin-bottom: 15px;">
        <p><strong>Room Capacity:</strong></p>
        <select id="schedule-capacity"
          style="width:100%; margin-top:5px; padding:10px; background:#0F0F0F; border:1px solid var(--border); border-radius:8px; color:white; cursor:pointer;">
          <script>
            for (let i = 1; i <= 20; i++) {
              document.write(`<option value="${i}" ${i === 8 ? 'selected' : ''}>${i} Users</option>`);
            }
          </script>
        </select>
      </div>

      <div style="margin-bottom: 20px;">
        <label style="display:flex; align-items:center; gap:8px;">
          <input type="checkbox" id="schedule-is-public">
          <span>Make it a public room</span>
        </label>
      </div>

      <div style="display:flex; gap:10px;">
        <button onclick="saveScheduledRoom()" style="flex:1;">Schedule</button>
        <button onclick="closeScheduleModal()"
          style="flex:1; background:transparent; border:1px solid var(--border); color:var(--text-main);">Cancel</button>
      </div>

      <p id="schedule-error" style="color:#ff3366; margin-top:10px; font-size:0.9rem;"></p>
    </div>
  </div>





  <!-- ROOM OPTIONS MODAL -->
  <div id="room-options-modal" class="modal">
    <div class="modal-content" style="text-align:center;">
      <h2>Select an Option</h2>
      <div style="display:flex; gap:20px; justify-content:center; margin-top:20px;">
        <button class="create-btn" onclick="openCreateModalFromOptions()"
          style="padding:20px 40px; font-size:1.2rem;">Create Room</button>
        <button class="join-btn" onclick="promptJoinFromOptions()" style="padding:20px 40px; font-size:1.2rem;">Join
          Room</button>
      </div>
    </div>
  </div>

  <!-- JAVASCRIPT -->
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
  <script>
    // Check Auth
    if (localStorage.getItem('isLoggedIn') !== 'true') {
      location.href = 'index.html';
    }

    const userName = localStorage.getItem('userName') || 'User';
    // document.getElementById('user-name').innerText = userName; // This element does not exist in the provided HTML

    // Fetch Friends
    async function fetchFriends() {
      const token = localStorage.getItem('token');
      const grid = document.getElementById('friends-grid');

      if (!token) return;
      if (!grid) {
        console.warn("friends-grid element missing");
        return;
      }

      try {
        const res = await fetch(CONFIG.getApiUrl('/api/friends'), {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (res.status === 401) {
          localStorage.clear();
          location.href = 'index.html';
          return;
        }

        if (!res.ok) throw new Error("Failed to fetch friends");

        const friends = await res.json();

        if (!Array.isArray(friends) || friends.length === 0) {
          grid.innerHTML = '<p style="color:#666; font-size: 0.9rem;">No friends yet. Join a room to make connections!</p>';
          return;
        }

        grid.innerHTML = friends.map(f => {
          const avatarUrl = f.avatar || `https://api.dicebear.com/7.x/avataaars/svg?seed=${encodeURIComponent(f.name)}`;
          const statusColor = {
            'available': '#2ecc71',
            'watching': '#f1c40f',
            'dnd': '#e74c3c',
            'silent': '#95a5a6',
            'offline': '#444'
          }[f.status] || '#444';

          return `
            <div class="card friend-card" data-userid="${f.id}" style="padding:15px; display:flex; align-items:center; gap:12px; background: rgba(255,255,255,0.03); border:none; position:relative;">
              <div style="position:relative; width:40px; height:40px;">
                <img src="${avatarUrl}" style="width:100%; height:100%; border-radius:50%; object-fit:cover; border:1px solid #333;">
                <div class="status-dot" style="position:absolute; bottom:0; right:0; width:10px; height:10px; background:${statusColor}; border-radius:50%; border:2px solid #141414;"></div>
              </div>
              <div>
                <h3 style="font-size:0.95rem; margin:0; color:white;">${f.name}</h3>
                <p class="status-text" style="font-size:0.75rem; color:#888; margin:0; margin-top:2px; text-transform:capitalize;">${f.status || 'offline'}</p>
              </div>
            </div>
            `;
        }).join('');

      } catch (err) {
        console.error("Failed to fetch friends:", err);
        grid.innerHTML = '<p style="color:#e50914; font-size:0.9rem;">Could not load friends.</p>';
      }
    }

    document.addEventListener('DOMContentLoaded', fetchFriends);

    // Fetch User Stats
    async function fetchStats() {
      const token = localStorage.getItem('token');
      if (!token) return;

      try {
        const res = await fetch(CONFIG.getApiUrl('/api/auth/stats'), {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        if (res.ok) {
          const stats = await res.json();

          // Update Reaction Leader
          if (stats.topReactions && stats.topReactions.length > 0) {
            const top = stats.topReactions[0];
            document.getElementById('reaction-leader').innerHTML =
              `<span style="font-size: 2.5rem; display: block; margin-bottom: 5px;">${top.emoji}</span> Used ${top.count} times`;
          }
        }

        // Fresh Drops
        const dropRes = await fetch(CONFIG.getApiUrl('/api/fresh-drops'));
        if (dropRes.ok) {
          const drops = await dropRes.json();
          const container = document.getElementById('fresh-drops-container');
          const drop = drops[Math.floor(Math.random() * drops.length)];
          if (container) {
            container.innerHTML = `
              <div style="background:rgba(229,9,20,0.1); padding:15px; border-radius:10px; border-left:4px solid var(--accent); text-align:left;">
                <span style="font-size:0.7rem; text-transform:uppercase; color:var(--accent); font-weight:800;">Recently Released</span>
                <h4 style="font-size:1.2rem; margin:5px 0;">${drop.title}</h4>
                <p style="font-size:0.8rem; color:#888;">${drop.type} ‚Ä¢ ${drop.stars}</p>
                <span style="display:inline-block; margin-top:10px; background:#222; padding:3px 8px; border-radius:4px; font-size:0.7rem; color:#ccc;">${drop.platform}</span>
              </div>
            `;
          }
        }

        // Fetch Scheduled Rooms
        fetchScheduledRooms();
      } catch (err) {
        console.error("Failed to fetch dashboard stats:", err);
      }
    }

    // Fetch and display scheduled rooms
    async function fetchScheduledRooms() {
      const token = localStorage.getItem('token');
      if (!token) return;

      const container = document.getElementById('next-watch-container');
      if (!container) return;

      try {
        const res = await fetch(CONFIG.getApiUrl('/api/scheduled-rooms'), {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (res.ok) {
          const scheduledRooms = await res.json();

          if (scheduledRooms.length === 0) {
            container.innerHTML = `
              <p style="color:#666;">No upcoming scheduled rooms.</p>
              <button onclick="openScheduleModal()" style="margin-top:10px; padding:8px 16px; font-size:0.85rem; height:auto; width:auto; min-width:0;">Schedule Room</button>
            `;
            return;
          }

          // Show the next upcoming room
          const nextRoom = scheduledRooms[0];
          const scheduledDate = new Date(nextRoom.scheduled_at);
          const now = new Date();
          const timeUntil = scheduledDate - now;
          const hoursUntil = Math.floor(timeUntil / (1000 * 60 * 60));
          const minutesUntil = Math.floor((timeUntil % (1000 * 60 * 60)) / (1000 * 60));
          const daysUntil = Math.floor(hoursUntil / 24);

          let timeText = '';
          if (daysUntil > 0) {
            timeText = `${daysUntil} day${daysUntil > 1 ? 's' : ''} away`;
          } else if (hoursUntil > 0) {
            timeText = `${hoursUntil} hour${hoursUntil > 1 ? 's' : ''} away`;
          } else {
            timeText = `${minutesUntil} minute${minutesUntil > 1 ? 's' : ''} away`;
          }

          const dateStr = scheduledDate.toLocaleDateString('en-IN', {
            timeZone: 'Asia/Kolkata',
            month: 'short',
            day: 'numeric',
            year: 'numeric'
          });

          const timeStr = scheduledDate.toLocaleTimeString('en-IN', {
            timeZone: 'Asia/Kolkata',
            hour: 'numeric',
            minute: '2-digit'
          });
          container.innerHTML = `
            <div style="background:rgba(229,9,20,0.1); padding:15px; border-radius:10px; border-left:4px solid var(--accent); text-align:left;">
              <h4 style="font-size:1.1rem; margin:0 0 8px 0; color:white;">${nextRoom.room_name}</h4>
              <p style="font-size:0.85rem; color:#888; margin:4px 0;">
                üìÖ ${dateStr} at ${timeStr}
              </p>
              <p style="font-size:0.85rem; color:var(--accent); margin:4px 0; font-weight:600;">
                ‚è∞ ${timeText}
              </p>
              <div style="margin-top:12px; display:flex; gap:8px; align-items:center;">
                <span style="background:#222; padding:3px 8px; border-radius:4px; font-size:0.7rem; color:#ccc;">${nextRoom.capacity} slots</span>
                ${nextRoom.is_public ? '<span style="background:#222; padding:3px 8px; border-radius:4px; font-size:0.7rem; color:#ccc;">Public</span>' : ''}
                <button onclick="deleteScheduledRoom(${nextRoom.id})" style="margin-left:auto; padding:4px 10px; font-size:0.75rem; height:auto; width:auto; min-width:0; background:transparent; border:1px solid #444; color:#aaa;">Cancel</button>
              </div>
              
              <div style="margin-top:15px; display:flex; gap:10px;">
                ${nextRoom.is_public ? `
                  <button onclick="joinScheduledRoom('${nextRoom.room_code}')" style="flex:1; padding:8px; font-size:0.85rem; background:var(--accent); color:white; border:none; border-radius:6px; cursor:pointer; font-weight:700;">Join Room</button>
                ` : `
                  <button onclick="copyScheduledCode('${nextRoom.room_code}')" style="flex:1; padding:8px; font-size:0.85rem; background:#333; color:white; border:none; border-radius:6px; cursor:pointer;">Copy Code</button>
                  <button onclick="joinScheduledRoom('${nextRoom.room_code}')" style="flex:1; padding:8px; font-size:0.85rem; background:var(--accent); color:white; border:none; border-radius:6px; cursor:pointer; font-weight:700;">Go to Room</button>
                `}
              </div>
            </div>
            ${scheduledRooms.length > 1 ? `<p style="margin-top:10px; font-size:0.8rem; color:#666;">+${scheduledRooms.length - 1} more scheduled</p>` : ''}
            <button onclick="openScheduleModal()" style="margin-top:10px; padding:8px 16px; font-size:0.85rem; height:auto; width:auto; min-width:0;">Schedule Another</button>
          `;
        }
      } catch (err) {
        console.error("Failed to fetch scheduled rooms:", err);
        container.innerHTML = '<p style="color:#e50914; font-size:0.9rem;">Failed to load scheduled rooms.</p>';
      }
    }

    // Schedule Room Functions
    function openScheduleModal() {
      document.getElementById('schedule-modal').style.display = 'flex';
      document.getElementById('schedule-error').textContent = '';

      // Set minimum datetime to now
      const now = new Date();
      now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
      document.getElementById('schedule-datetime').min = now.toISOString().slice(0, 16);
    }

    function closeScheduleModal() {
      document.getElementById('schedule-modal').style.display = 'none';
      document.getElementById('schedule-room-name').value = '';
      document.getElementById('schedule-datetime').value = '';
      document.getElementById('schedule-error').textContent = '';
    }

    async function saveScheduledRoom() {
      const token = localStorage.getItem('token');
      if (!token) return;

      const roomName = document.getElementById('schedule-room-name').value.trim();
      const datetimeInput = document.getElementById('schedule-datetime').value;
      const capacity = document.getElementById('schedule-capacity').value;
      const isPublic = document.getElementById('schedule-is-public').checked;
      const errorEl = document.getElementById('schedule-error');

      if (!roomName) {
        errorEl.textContent = 'Please enter a room name';
        return;
      }

      if (!datetimeInput) {
        errorEl.textContent = 'Please select date & time';
        return;
      }

      // üîπ Standard ISO conversion (Browser handles local timezone)
      const scheduledDate = new Date(datetimeInput);

      try {
        const res = await fetch(CONFIG.getApiUrl('/api/scheduled-rooms'), {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({
            roomName,
            scheduledAt: scheduledDate.toISOString(),
            capacity: parseInt(capacity),
            isPublic
          })
        });

        const data = await res.json();

        if (!res.ok) {
          errorEl.textContent = data.error || 'Failed to schedule room';
          return;
        }

        closeScheduleModal();
        fetchScheduledRooms();

      } catch (err) {
        console.error(err);
        errorEl.textContent = 'Network error';
      }
    }

    async function deleteScheduledRoom(roomId) {
      if (!confirm('Are you sure you want to cancel this scheduled room?')) return;

      const token = localStorage.getItem('token');
      if (!token) return;

      try {
        const res = await fetch(CONFIG.getApiUrl(`/api/scheduled-rooms/${roomId}`), {
          method: 'DELETE',
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (res.ok) {
          fetchScheduledRooms(); // Refresh the display
        } else {
          alert('Failed to cancel scheduled room');
        }
      } catch (err) {
        console.error("Delete scheduled room error:", err);
        alert('Network error. Please try again.');
      }
    }

    function copyScheduledCode(code) {
      if (!code) return;
      navigator.clipboard.writeText(code);
      alert('Room code copied: ' + code);
    }

    function joinScheduledRoom(code) {
      if (!code) return;
      sessionStorage.setItem('isHost', 'true'); // Assume host for their scheduled room
      location.href = `room.html?code=${code}`;
    }

    document.addEventListener('DOMContentLoaded', fetchStats);

    // Initialize Socket for Create Room events
    const socket = io(CONFIG.SOCKET_URL);

    // Sync Initial Status
    const initialStatus = localStorage.getItem('userStatus') || 'available';
    const currentUserId = localStorage.getItem('userId');
    if (currentUserId) {
      socket.emit('updateStatus', { userId: currentUserId, status: initialStatus });
    }

    function syncStatusToServer(status) {
      const userId = localStorage.getItem('userId');
      if (userId) {
        socket.emit('updateStatus', { userId, status });
      }
    }

    // Real-time Status Updates
    socket.on('statusUpdate', ({ userId, status }) => {
      console.log(`[DEBUG] Received real-time status update: ${userId} -> ${status}`);

      const statusColor = {
        'available': '#2ecc71',
        'watching': '#f1c40f',
        'dnd': '#e74c3c',
        'silent': '#95a5a6',
        'offline': '#444'
      }[status] || '#444';

      const card = document.querySelector(`.friend-card[data-userid="${userId}"]`);
      if (card) {
        const dot = card.querySelector('.status-dot');
        const text = card.querySelector('.status-text');
        if (dot) dot.style.background = statusColor;
        if (text) text.innerText = status;
        console.log(`[DEBUG] Surgically updated UI for user ${userId}`);
      } else {
        // Fallback if card isn't found (e.g., friend just added)
        fetchFriends();
      }
    });

    function logout() {
      if (confirm("Are you sure you want to logout?")) {
        const uId = localStorage.getItem('userId');
        if (uId) {
          socket.emit('updateStatus', { userId: uId, status: 'offline' });
        }
        localStorage.clear();
        location.href = "index.html";
      }
    }

    let currentCode = '';
    let roomType = 'private';

    function setRoomType(type) {
      roomType = type;
      const btnPrivate = document.getElementById('btn-private');
      const btnPublic = document.getElementById('btn-public');
      const publicOptions = document.getElementById('public-options');

      if (type === 'private') {
        btnPrivate.classList.add('active');
        btnPrivate.style.background = 'var(--accent)';
        btnPrivate.style.color = 'white';
        btnPrivate.style.border = 'none';

        btnPublic.classList.remove('active');
        btnPublic.style.background = 'transparent';
        btnPublic.style.color = '#aaa';
        btnPublic.style.border = '1px solid #444';

        publicOptions.style.display = 'none';
      } else {
        btnPublic.classList.add('active');
        btnPublic.style.background = 'var(--accent)';
        btnPublic.style.color = 'white';
        btnPublic.style.border = 'none';

        btnPrivate.classList.remove('active');
        btnPrivate.style.background = 'transparent';
        btnPrivate.style.color = '#aaa';
        btnPrivate.style.border = '1px solid #444';

        publicOptions.style.display = 'block';
      }
    }

    // Navbar Room Link Handler
    document.querySelector('a[href="room.html"]').addEventListener('click', (e) => {
      e.preventDefault();
      document.getElementById('room-options-modal').style.display = 'flex';
    });

    function openCreateModal() {
      document.getElementById('create-modal').style.display = 'flex';
    }

    function openCreateModalFromOptions() {
      document.getElementById('room-options-modal').style.display = 'none';
      openCreateModal();
    }

    function createRoomWithCapacity() {
      currentCode = 'FRM' + Math.random().toString(36).substr(2, 3).toUpperCase();
      const capacity = document.getElementById('capacity-select').value;
      const userName = localStorage.getItem('userName') || 'Host';

      // Set Host Flag
      sessionStorage.setItem('isHost', 'true');

      if (roomType === 'public') {
        const roomName = document.getElementById('room-name-input').value.trim();
        if (!roomName) return alert("Please enter a room name for public rooms.");

        const token = localStorage.getItem('token');
        const email = localStorage.getItem('userEmail');

        // Emit to server to register public room
        socket.emit('createRoom', {
          roomCode: currentCode,
          type: 'public',
          name: roomName,
          capacity: capacity,
          userName: userName,
          token,
          email
        }, (res) => {
          if (res && res.success) {
            // Redirect ONLY after server confirms DB save
            location.href = `room.html?code=${currentCode}`;
          }
        });

      } else {
        // Emit to server to register private room (for DB persistence)
        socket.emit('createRoom', {
          roomCode: currentCode,
          type: 'private',
          name: 'Private Room',
          capacity: capacity,
          userName: userName,
          token: localStorage.getItem('token'),
          email: localStorage.getItem('userEmail')
        }, (res) => {
          if (res && res.success) {
            console.log("Private room saved to DB");
          }
        });

        // Private Room - Show Success Modal
        document.getElementById('room-code').innerText = currentCode;
        document.getElementById('room-link').innerText = `framesync.in/room/${currentCode}`;

        document.getElementById('create-modal').style.display = 'none';
        document.getElementById('success-modal').style.display = 'flex';
      }
    }

    function copyCode() {
      navigator.clipboard.writeText(currentCode);
      alert('Code copied!');
    }

    function copyLink() {
      navigator.clipboard.writeText(`framesync.in/room/${currentCode}`);
      alert('Link copied!');
    }

    function goToRoom() {
      location.href = `room.html?code=${currentCode}`;
    }

    function promptJoin() {
      const code = prompt('Enter Room Code:')?.trim().toUpperCase();

      if (code && code.length === 6) {
        sessionStorage.setItem('isHost', 'false'); // Ensure guest
        location.href = `room.html?code=${code}`;
      } else if (code) {
        alert('Invalid code! Must be 6 letters.');
      }
    }

    function promptJoinFromOptions() {
      document.getElementById('room-options-modal').style.display = 'none';
      promptJoin();
    }

    window.onclick = e => {
      if (e.target.classList.contains('modal')) {
        e.target.style.display = 'none';
        // Clear schedule modal fields when closing
        if (e.target.id === 'schedule-modal') {
          closeScheduleModal();
        }
      }
    };
  </script>

</body>

</html>