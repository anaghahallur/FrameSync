<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Room ‚Ä¢ FrameSync</title>
  <link rel="stylesheet" href="style.css">
  <style>
    /* Room-Specific Overrides */
    body {
      padding: 20px;
      overflow: hidden;
      /* Prevent full page scroll, handle in containers */
    }

    .room-container {
      max-width: 1600px;
      margin: 0 auto;
      display: flex;
      gap: 20px;
      height: calc(100vh - 40px);
    }

    .video-section {
      flex: 3;
      background: var(--bg-card);
      border-radius: 16px;
      border: 1px solid var(--border);
      padding: 20px;
      display: flex;
      flex-direction: column;
      overflow-y: auto;
      position: relative;
    }

    .side-section {
      flex: 1;
      background: var(--bg-card);
      border-radius: 16px;
      border: 1px solid var(--border);
      padding: 20px;
      display: flex;
      flex-direction: column;
      min-width: 300px;
    }

    #video-player {
      width: 100%;
      aspect-ratio: 16/9;
      background: #000;
      border-radius: 12px;
      margin-bottom: 20px;
      border: 1px solid var(--border);
    }

    .host-controls {
      display: none;
      gap: 15px;
      margin-bottom: 20px;
      background: var(--bg-panel);
      padding: 20px;
      border-radius: 12px;
      border: 1px solid var(--border);
    }

    .user-list,
    .chat-box {
      background: var(--bg-panel);
      border-radius: 12px;
      padding: 15px;
      margin-top: 15px;
      flex-grow: 1;
      overflow-y: auto;
      border: 1px solid var(--border);
    }

    .chat-box {
      max-height: 400px;
    }

    .leave-btn {
      margin-top: auto;
      background: #b91c1c !important;
      /* Darker red for leave */
      border-color: #b91c1c !important;
      color: white;
    }

    .leave-btn:hover {
      background: #dc2626 !important;
    }

    /* Button Overrides removed to match dashboard style.css */
    /* .btn class will now inherit from button tag in style.css */

    .chat-send-btn {
      width: 100%;
      margin-top: 15px;
    }

    .user-list {
      min-height: 150px;
      color: var(--text-main);
    }

    /* Ensure text is visible in inputs */
    input[type="text"] {
      color: white;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid var(--border);
    }

    .chat-send-btn {
      width: 100%;
      margin-top: 15px;
    }

    /* Tabs Overrides */
    .tab-btn {
      color: var(--text-muted);
      transition: 0.3s;
      font-size: 1rem;
      padding: 10px 20px;
    }

    .tab-btn:hover {
      color: white;
    }

    .tab-btn.active {
      color: var(--accent) !important;
      border-bottom-color: var(--accent) !important;
    }

    /* Video Bubble Overrides for Theme */
    .video-bubble {
      border-color: var(--accent);
      background: var(--bg-card);
    }

    .avatar-placeholder {
      background: var(--bg-panel);
      color: var(--text-muted);
    }

    @keyframes floatUp {
      0% {
        transform: translateY(0) scale(1);
        opacity: 1;
      }

      100% {
        transform: translateY(-200px) scale(1.5);
        opacity: 0;
      }
    }
  </style>
</head>

<body>


  <!-- CUSTOM STYLES FOR FLOATING UI -->
  <style>
    .bottom-toolbar {
      width: 100%;
      height: 60px;
      background: var(--bg-panel);
      border-top: 1px solid var(--border);
      display: flex;
      flex-direction: row;
      justify-content: center;
      align-items: center;
      gap: 30px;
      z-index: 100;
      position: absolute;
      bottom: 0;
      left: 0;
    }

    .icon-btn {
      background: none;
      border: none;
      font-size: 1.6rem;
      cursor: pointer;
      opacity: 0.6;
      transition: 0.2s;
      padding: 10px;
      border-radius: 12px;
      color: var(--text-main);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .icon-btn:hover,
    .icon-btn.active {
      opacity: 1;
      background: rgba(255, 255, 255, 0.1);
      color: var(--accent);
      transform: scale(1.1);
    }

    .floating-panel {
      position: absolute;
      top: 0;
      right: 0;
      width: 320px;
      height: calc(100% - 60px);
      /* Subtract toolbar height */
      background: rgba(10, 10, 10, 0.95);
      backdrop-filter: blur(15px);
      border-left: 1px solid var(--border);
      transform: translateX(120%);
      transition: transform 0.4s cubic-bezier(0.2, 0.8, 0.2, 1);
      z-index: 90;
      display: flex;
      flex-direction: column;
      padding: 20px;
      box-shadow: -10px 0 30px rgba(0, 0, 0, 0.5);
    }

    .floating-panel.open {
      transform: translateX(0);
    }

    .panel-header {
      font-size: 1.4rem;
      font-weight: 800;
      margin-bottom: 20px;
      color: var(--accent);
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid var(--border);
      padding-bottom: 10px;
    }
  </style>

  <!-- MAIN CONTAINER (Refactored) -->
  <div class="room-container"
    style="display:flex; flex-direction:column; width:100%; height:calc(100vh - 80px); position:relative; overflow:hidden;">

    <!-- VIDEO SECTION (Full Width) -->
    <div class="video-section"
      style="flex:1; padding:20px; display:flex; flex-direction:column; overflow:hidden; position:relative; padding-bottom:80px;">
      <div id="player-container"
        style="width:100%; height:100%; background:#000; border-radius:24px; margin-bottom:0; overflow:hidden; position:relative; flex:1;">
        <div id="video-player" style="height:100%; width:100%;"></div>
        <!-- Remove 'controls' attribute by default -->
        <video id="html5-player" style="width:100%; height:100%; display:none;"></video>

        <!-- GUEST OVERLAY (Blocks interaction) -->
        <div id="guest-overlay"
          style="display:none; position:absolute; top:0; left:0; width:100%; height:100%; z-index:10; cursor:default;">
        </div>

        <!-- HIGHLIGHT REEL MODAL -->
        <div id="highlight-modal"
          style="display:none; position:absolute; inset:0; background:rgba(0,0,0,0.9); z-index:200; flex-direction:column; justify-content:center; align-items:center;">
          <h2 style="margin-bottom:20px; color:var(--accent);">üé¨ Session Highlights</h2>
          <video id="highlight-preview" controls
            style="width:80%; max-height:60vh; border:2px solid var(--border); border-radius:12px; margin-bottom:20px;"></video>
          <div style="display:flex; gap:20px;">
            <a id="download-highlight-btn" class="btn" download="FrameSync-Highlights.webm"
              style="text-decoration:none; display:flex; align-items:center; gap:8px;">
              ‚¨áÔ∏è Download Reel
            </a>
            <button onclick="closeHighlightModal()" class="btn"
              style="background:#333; border-color:#555;">Close</button>
          </div>
        </div>
      </div>

      <!-- HOST CONTROLS (Floating Overlay) -->
      <div id="host-controls" class="host-controls"
        style="display:none; position:absolute; bottom:90px; left:50%; transform:translateX(-50%); width:600px; background:rgba(0,0,0,0.8); backdrop-filter:blur(10px); padding:15px; border-radius:16px; border:1px solid rgba(255,255,255,0.1); z-index:80; flex-direction:column; gap:10px;">

        <div style="display:flex; justify-content:space-between; align-items:center; width:100%;">
          <div style="display:flex; gap:10px;">
            <button id="tab-youtube-btn" onclick="switchControlTab('youtube')" class="btn tab-btn"
              style="padding:8px 15px; font-size:0.9rem;">YouTube</button>
            <button id="tab-file-btn" onclick="switchControlTab('file')" class="btn tab-btn"
              style="padding:8px 15px; font-size:0.9rem; opacity:0.5;">File</button>
          </div>

          <!-- YouTube Inputs -->
          <div id="tab-youtube" class="control-tab" style="flex:1; display:flex; gap:10px; margin-left:15px;">
            <input type="text" id="youtube-link" placeholder="Paste YouTube link..."
              style="flex:1; padding:8px; background:rgba(255,255,255,0.1); border:1px solid #444; color:white; border-radius:6px;">
            <button class="btn" onclick="loadYouTube()">Load</button>
          </div>

          <!-- File Inputs -->
          <div id="tab-file" class="control-tab"
            style="display:none; flex:1; gap:30px; align-items:center; margin-left:15px;">
            <label class="btn btn-sm" style="cursor:pointer;">Video <input type="file" id="file-upload"
                accept="video/*,.mkv" style="display:none" onchange="handleFileSelect(this, 'video')"></label>
            <span id="file-name-display"
              style="font-size:0.8rem; color:#888; max-width:100px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;"></span>

            <label class="btn btn-sm" style="cursor:pointer;">Subtitle <input type="file" id="sub-upload"
                accept=".vtt,.srt" style="display:none" onchange="handleFileSelect(this, 'subtitle')"></label>
            <span id="sub-name-display"
              style="font-size:0.8rem; color:#888; max-width:100px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;"></span>

            <button class="btn" onclick="uploadFiles()">Play</button>
          </div>
          <div id="subdl-results"
            style="display:none; position:absolute; bottom:100%; left:0; width:100%; background:rgba(0,0,0,0.95); backdrop-filter:blur(20px); padding:15px; border-radius:12px; border:1px solid rgba(229,9,20,0.3); max-height:250px; overflow-y:auto; z-index:100; box-shadow: 0 -10px 30px rgba(0,0,0,0.5);">
          </div>
        </div>
      </div>
    </div>

    <!-- BOTTOM TOOLBAR (Icons) -->
    <div class="bottom-toolbar" style="justify-content: space-between; padding: 0 30px;">

      <!-- LEFT: Leave Room -->
      <button class="leave-btn" onclick="leaveRoom()" title="Leave Room" style="
          background: rgba(255, 68, 68, 0.1) !important;
          color: #ff4444 !important;
          border: 1px solid rgba(255, 68, 68, 0.5) !important;
          width: auto;
          padding: 10px 24px;
          border-radius: 50px;
          font-weight: bold;
          font-size: 0.95rem;
          cursor: pointer;
          transition: all 0.2s ease;
          display: flex;
          align-items: center;
          gap: 8px;
          margin: 0;
        "
        onmouseover="this.style.background='#ff4444'; this.style.color='white'; this.style.boxShadow='0 0 15px rgba(255,68,68,0.4)';"
        onmouseout="this.style.background='rgba(255, 68, 68, 0.1)'; this.style.color='#ff4444'; this.style.boxShadow='none';">
        <span style="font-size:1.1rem">üö™</span> Leave Room
      </button>

      <!-- CENTER: Controls -->
      <div style="display:flex; gap:15px; align-items:center; position:absolute; left:50%; transform:translateX(-50%);">
        <button id="btn-users" class="icon-btn" onclick="togglePanel('user-panel')" title="Users">üë•</button>
        <button id="btn-chat" class="icon-btn" onclick="togglePanel('chat-panel')" title="Chat">üí¨</button>
        <!-- Highlight Toggle -->
        <button id="btn-highlight" class="icon-btn" onclick="startHighlighting()" style="display:none;"
          title="Enable Highlights">‚ö™</button>
        <!-- Host Control Toggle (Visible if Host) -->
        <button id="btn-host-tools" class="icon-btn" onclick="toggleHostControls()" style="display:none;"
          title="Host Tools">üõ†Ô∏è</button>
      </div>

      <!-- RIGHT: Spacer -->
      <div style="width: 120px;"></div>
    </div>

    <!-- FLOATING USER PANEL -->
    <div id="user-panel" class="floating-panel">
      <div class="panel-header">Users <span id="peer-count"
          style="font-size:0.9rem; font-weight:normal; opacity:0.7;">(0)</span></div>
      <div id="user-list" class="user-list" style="flex:1; overflow-y:auto; padding-right:5px;"></div>
    </div>

    <!-- FLOATING CHAT PANEL -->
    <div id="chat-panel" class="floating-panel">
      <div class="panel-header">Chat</div>
      <div id="chat-box" class="chat-box"
        style="flex:1; overflow-y:auto; margin-bottom:15px; background:rgba(0,0,0,0.2); border-radius:8px; padding:10px;">
      </div>

      <div style="display:flex; gap:10px; margin-bottom:15px;">
        <input type="text" id="chat-input" placeholder="Message..." onkeypress="if(event.key==='Enter') sendMessage()"
          style="flex:1;">
        <button class="btn chat-send-btn" onclick="sendMessage()" style="margin:0; padding:0 15px;">‚û§</button>
      </div>

      <!-- REACTION BAR -->
      <div id="reaction-bar" style="display:grid; grid-template-columns:repeat(3, 1fr); gap:8px;">
        <button onclick="sendReaction('‚ù§Ô∏è')" class="btn"
          style="background:rgba(255,255,255,0.1); border:none; padding:8px;">‚ù§Ô∏è</button>
        <button onclick="sendReaction('üòÇ')" class="btn"
          style="background:rgba(255,255,255,0.1); border:none; padding:8px;">üòÇ</button>
        <button onclick="sendReaction('üòÆ')" class="btn"
          style="background:rgba(255,255,255,0.1); border:none; padding:8px;">üòÆ</button>
        <button onclick="sendReaction('üò¢')" class="btn"
          style="background:rgba(255,255,255,0.1); border:none; padding:8px;">üò¢</button>
        <button onclick="sendReaction('üò°')" class="btn"
          style="background:rgba(255,255,255,0.1); border:none; padding:8px;">üò°</button>
        <button onclick="sendReaction('üéâ')" class="btn"
          style="background:rgba(255,255,255,0.1); border:none; padding:8px;">üéâ</button>
      </div>
    </div>

  </div>

  <!-- SOCKET.IO + YOUTUBE API -->
  <script src="/socket.io/socket.io.js"></script>
  <script src="https://www.youtube.com/iframe_api"></script>

  <!-- ORPHANED CSS RECOVERY -->
  <style>
    .video-bubble {
      position: fixed;
      width: 150px;
      height: 150px;
      border-radius: 50%;
      border: 3px solid var(--accent);
      overflow: hidden;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
      cursor: grab;
      z-index: 1500;
      background: #000;
      transition: transform 0.1s;
    }

    .video-bubble:active {
      cursor: grabbing;
      transform: scale(1.05);
    }

    .video-bubble video {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .video-bubble .name-tag {
      position: absolute;
      bottom: 10px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.6);
      padding: 2px 8px;
      border-radius: 10px;
      font-size: 0.7rem;
      font-weight: bold;
      pointer-events: none;
      z-index: 2;
    }

    .bubble-controls {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.6);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 10px;
      opacity: 0;
      transition: opacity 0.2s;
      z-index: 3;
    }

    .video-bubble:hover .bubble-controls {
      opacity: 1;
    }

    .bubble-btn {
      background: rgba(255, 255, 255, 0.2);
      border: none;
      border-radius: 50%;
      width: 35px;
      height: 35px;
      cursor: pointer;
      color: white;
      font-size: 1rem;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.2s;
    }

    .bubble-btn:hover {
      background: var(--accent);
    }

    .connect-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      z-index: 4;
    }

    .avatar-placeholder {
      width: 100%;
      height: 100%;
      background: #333;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2rem;
      font-weight: bold;
      color: #777;
      position: absolute;
      top: 0;
      left: 0;
    }
  </style>

  <script src="room.js"></script>
</body>

</html>